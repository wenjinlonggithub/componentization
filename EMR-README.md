# EMR电子病历系统 - 组件化架构实现

基于原有的组件化架构，本项目扩展实现了电子病历(EMR)系统，展示了两种不同租户的病历存储和处理需求。

## EMR功能特性

### 核心病历字段
- **主诉**: 患者主要症状描述
- **现病史**: 当前疾病的详细病史
- **既往病史**: 患者既往疾病历史
- **过敏史**: 药物或物质过敏记录
- **诊断**: 医生的诊断结论
- **建议**: 治疗建议和医嘱
- **其他**: 补充说明信息

## 租户差异化实现

### 租户1 - 数据集存储模式（研究型医院）
**特点**: 将病历数据保存为CSV格式的数据集，用于医学研究和数据分析

**核心功能**:
- 病历数据标准化处理
- 数据质量检查和验证
- CSV格式数据集生成
- 数据集统计分析
- 自动备份和归档

**实现方式**:
- `CustomMedicalRecordProcessor`: 继承模式，覆盖保存逻辑
- `DatasetStorageService`: 专门的数据集存储服务
- `MedicalRecordEventListener`: 事件监听，处理数据集分析

### 租户2 - 企业数据库+HIS系统上报（综合医院）
**特点**: 企业级病历管理，数据库存储+HIS系统集成

**核心功能**:
- 企业级数据验证（合规性、安全性、质量检查）
- 数据库持久化存储
- HIS系统数据上报
- 企业工作流触发
- 完整的审计日志

**实现方式**:
- `EnterpriseMedicalRecordListener`: 纯事件驱动模式
- `DatabaseService`: 企业数据库服务
- `HisIntegrationService`: HIS系统集成服务
- 完整的企业级处理流程

## 项目结构

```
componentization/
├── core-system/                    # 核心EMR功能
│   ├── model/                      # MedicalRecord, Patient
│   ├── processor/                  # MedicalRecordProcessor接口和默认实现
│   ├── event/                      # EMR相关事件
│   └── config/                     # 核心配置
├── customization-tenant1/          # 租户1定制（数据集模式）
│   ├── service/DatasetStorageService      # 数据集存储服务
│   ├── processor/CustomMedicalRecordProcessor  # 定制处理器
│   └── listener/MedicalRecordEventListener     # 事件监听器
├── customization-tenant2/          # 租户2定制（企业模式）
│   ├── service/DatabaseService            # 数据库服务
│   ├── service/HisIntegrationService      # HIS集成服务
│   └── listener/EnterpriseMedicalRecordListener # 企业事件监听器
├── emr-tenant1-app/                # 租户1 EMR应用（端口8091）
└── emr-tenant2-app/                # 租户2 EMR应用（端口8092）
```

## 构建和运行

### 1. 构建所有模块
```bash
mvn clean install
```

### 2. 运行租户1 EMR应用（数据集模式）
```bash
cd emr-tenant1-app
mvn spring-boot:run
```

### 3. 运行租户2 EMR应用（企业模式）
```bash
cd emr-tenant2-app
mvn spring-boot:run
```

## 运行效果演示

### 租户1输出示例（数据集存储）
```
=== EMR租户1应用演示（数据集存储模式） ===

--- 处理常规病历（数据集存储） ---
开始保存病历：患者ID=P001
病历数据验证通过
租户1：病历保存前进行数据质量检查
租户1：数据集质量检查完成
租户1：病历数据标准化完成
租户1事件监听：病历保存前处理
租户1：检查数据集存储状态
租户1：将病历保存到数据集文件
租户1：病历数据已写入数据集文件 - medical_records_dataset.csv
租户1：病历已保存到数据集，状态：SAVED_TO_DATASET
租户1事件监听：病历保存后处理
租户1：数据集统计 - 当前包含 1 条病历记录
租户1：执行数据集分析处理
租户1：新的病历记录已加入数据集，触发增量分析
租户1：诊断数据可用于疾病谱分析
```

### 租户2输出示例（企业数据库+HIS）
```
=== EMR租户2应用演示（企业版：数据库+HIS系统） ===

--- 处理企业级病历（数据库+HIS上报） ---
开始保存病历：患者ID=P003
病历数据验证通过
租户2事件监听：病历保存前企业级验证
租户2：执行企业级数据验证
租户2：数据质量检查完成
租户2：合规性检查完成
租户2：安全性检查完成
租户2：检查企业系统健康状态
租户2：数据库状态正常，记录数: 0
租户2：保存病历到企业数据库
租户2：病历已成功保存到数据库，ID: xxx
租户2：开始上报病历到HIS系统
租户2：验证HIS系统连接
租户2：转换病历数据为HIS标准格式
租户2：执行HIS系统数据上传
租户2：病历已成功上报到HIS系统，上传ID: HIS-xxx
租户2：执行企业级后续流程
租户2：触发企业工作流程
租户2：生成企业级报告
租户2：更新企业指标
```

## 核心架构优势

### 1. 扩展点设计
- `MedicalRecordProcessor`: 核心处理接口
- 钩子方法: `beforeSave()` 支持定制化逻辑
- 事件机制: 完整的生命周期事件

### 2. 两种定制化模式
- **继承模式**: 租户1直接继承并覆盖核心逻辑
- **事件驱动**: 租户2通过事件监听实现松耦合定制

### 3. 实际业务场景
- **研究型医院**: 需要数据集用于科研分析
- **综合医院**: 需要完整的企业级管理和HIS集成

### 4. 可扩展性
- 新增租户只需实现对应的定制化模块
- 核心病历处理逻辑保持稳定
- 支持混合定制模式（继承+事件）

这个EMR系统完整展示了组件化架构在实际医疗场景中的应用，通过不同的定制化策略满足不同类型医院的具体需求。